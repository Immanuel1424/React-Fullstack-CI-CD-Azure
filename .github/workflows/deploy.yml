name: Test SSH Access

on:
  workflow_dispatch:  # manually trigger it

jobs:
  test-ssh:
    runs-on: ubuntu-latest

    env:
      SSH_USER: ubuntu
      PUBLIC_IP: ${{ secrets.PUBLIC_INSTANCE_IP }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Start SSH Agent and Add Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_KEY }}

    - name: Debug - Show SSH agent status
      run: ssh-add -l

    - name: Add to known_hosts
      run: |
        ssh-keyscan -H $PUBLIC_IP >> ~/.ssh/known_hosts
        cat ~/.ssh/known_hosts

    - name: Test SSH connection with debug logs
      run: |
        ssh -v -o StrictHostKeyChecking=yes $SSH_USER@$PUBLIC_IP "echo 'âœ… SSH to public instance successful'"
